#!/bin/bash
# Manually rebuild and install an AUR package

set -eu -o pipefail

readonly PKG=$1
readonly EXT=".tar.zst"

if ! pacman -Q "$PKG" &> /dev/null ; then
    echo "$PKG is not installed, aborting"
    exit 1
fi

if pacman -Qe "$PKG" &> /dev/null ; then
    EXP_OR_DEP="--asexplicit"
elif pacman -Qd "$PKG" &> /dev/null ; then
    EXP_OR_DEP="--asdeps"
else
    echo "Could not determine if '$PKG' was installed explicitly or as a dependency. Aborting."
    exit 2
fi
readonly EXP_OR_DEP

readonly REPO="aurto"
readonly REPOPATH=/var/cache/pacman/"$REPO"

perform_build() {
    aurto remove "$PKG"
    aurto add "$PKG"
}

if perform_build ; then
    readonly PKGARRAY=("$REPOPATH"/"$PKG"*"$EXT")
    if [ ${#PKGARRAY[@]} -eq 0 ] ; then
        echo "Failed to find package matching $PKG in $REPOPATH"
        exit 3
    fi
    if [ ${#PKGARRAY[@]} -gt 1 ] ; then
        echo "Found multiple matches for $PKG in $REPOPATH"
        exit 4
    fi

    readonly PKGPATH="${PKGARRAY[0]}"
    if [ ! -f "$PKGPATH" ] ; then
        echo "Match $PKGPATH for package $PKG in $REPOPATH is not a file"
        exit 5
    fi

    # Install packages from database
    sudo pacman \
        --upgrade \
        "$EXP_OR_DEP" \
        "$PKGPATH"
fi
